<?php

namespace common\services;

use Yii;
use yii\base\Exception;
use yii\base\Component;


/**
 * 信用卡鉴权服务
 */
class CreditCardAuthenticationService extends Component
{

    //信用卡鉴权 务必先认证checkCardBin 不然银行卡也会通过认证
    public function check($card_no,$id_number,$name,$phone,$user_id = null)
    {
//        $service = new JieAnService();
        $service = new JingZhongService();


        $result = $service->check($card_no,$id_number,$name,$phone);
        return $result;
    }

    //检查卡号是否为13-19位纯数字
    public function checkNum($card_no)
    {
        $ret = preg_match("/^\d{13,19}$/",$card_no);
        if($ret){
            return true;
        }else{
            return false;
        }
    }

    //检查卡号长度 13-19位
    public function checkLen($card_no)
    {
        $len = strlen($card_no);
        if($len >= 13 && $len <= 19){
            return true;
        }else{
            return false;
        }
    }

    //检查卡bin
    public function checkCardBin($card_no, $bank_id)
    {
        if(!in_array($bank_id, array_keys(self::$BANK_LIST))){
            return [
                'code' => -1,
                'msg' => '该银行不支持'
            ];
        }

        $check_len = $this->checkLen($card_no);
        if(!$check_len){
            return [
                'code' => -1,
                'msg' => '卡号长度非法'
            ];
        }

        $check_num = $this->checkNum($card_no);
        if(!$check_num){
            return [
                'code' => -1,
                'msg' => '卡号非法'
            ];
        }

        $credit_card_bin = self::${self::$BANK_LIST[$bank_id]};
        foreach($credit_card_bin as $bin)
        {
            $len = strlen($bin);
            $card_heard = substr($card_no,0,$len);
            if($card_heard == $bin){
                return [
                    'code' => 0,
                    'msg' => '认证通过'
                ];
            }
        }
        return [
            'code' => -1,
            'msg' => '认证不通过'
        ];
    }

    //支持的银行列表
    public static $BANK_LIST = [
        "1" => 'ICBC_CARD_BIN', //工商银行
        "2" => 'ABC_CARD_BIN',//农业银行
        "3" => 'EB_CARD_BIN',//光大银行
        "4" => 'PSBC_CARD_BIN',//邮政储蓄银行
        "5" => 'CIB_CARD_BIN',//兴业银行
        "6" => 'SDB_CARD_BIN',//深圳发展银行
        "7" => 'CCB_CARD_BIN',//建设银行
        "8" => 'CMB_CARD_BIN',//招商银行
        "9" => 'BOC_CARD_BIN',//中国银行
        "10" => 'SPDB_CARD_BIN',//浦发银行
        "11" => 'PAB_CARD_BIN',//平安银行
        "12" => 'HXB_CARD_BIN',//华夏银行
        "13" => 'ECITIC_CARD_BIN',//中信银行
        "14" => 'BOCOM_CARD_BIN',//交通银行
        "15" => 'CMBC_CARD_BIN',//民生银行
        "16" => 'GDB_CARD_BIN',//广发银行
    ];

    //工商银行卡bin
    public static $ICBC_CARD_BIN = [
        370246,
        370248,
        370249,
        427010,
        427018,
        427019,
        427020,
        427029,
        427030,
        427039,
        370247,
        438125,
        438126,
        451804,
        451810,
        525498,
        622210,
        622211,
        622212,
        622213,
        622214,
        622220,
        622223,
        622225,
        622229,
        622230,
        622231,
        622232,
        622233,
        622234,
        622235,
        622237,
        622215,
        622239,
        622240,
        622245,
        622224,
        622238,
        62451804,
        62451810,
        62451811,
        6245806,
        62458071,
        6253098,
        628288,
        628286,
        622206,
        526836,
        513685,
        543098,
        458441,
        622246,
        451811,
        45806,
        458071,
        489734,
        489735,
        489736,
        510529,
        427062,
        524091,
        427064,
        530970,
        53098,
        530990,
        558360,
        524047,
        625160,
        625161,
        625162,
        622910,
        622911,
        622912,
        622913,
        625858,
        625859,
        625860,
        360883,
        360884,
        622597,
        622599,
        625650,
        625708,
        625709,
        625865,
        625866,
        625899,
        625115,
        622889,
        625900,
        625915,
        625916,
        622171,
        625332,
        622236,
        374738,
        374739,
        524374,
        550213,
        544210,
        548943,
        370267,
        356879,
        356880,
        356881,
        356882,
        528856,
        625330,
        625331
    ];

    //农业银行卡bin
    public static $ABC_CARD_BIN = [
        49102,
        514027,
        622836,
        622837,
        622839,
        628268,
        6349102,
        6353591,
        625996,
        625998,
        403361,
        404117,
        404118,
        404119,
        404120,
        404121,
        463758,
        519412,
        519413,
        520082,
        520083,
        53591,
        552599,
        558730,
        625997,
        628269,
        622820,
        622830,
        622838,
        625336,
        625826,
        625827,
        544243,
        548478
    ];

    //光大银行卡bin
    public static $EB_CARD_BIN = [
        622657,
        622685,
        622659,
        356837,
        356838,
        486497,
        406252,
        406254,
        425862,
        481699,
        524090,
        543159,
        622161,
        622570,
        622650,
        622655,
        622658,
        625975,
        625976,
        625977,
        628201,
        628202,
        462427,
        622687,
        625978,
        625980,
        625981,
        625979,
        356839,
        356840,
        622801,
        625339
    ];

    //邮政储蓄银行
    public static $PSBC_CARD_BIN = [
        518905,
        625368,
        622812,
        622810,
        622811,
        628310,
        625919
    ];

    //兴业银行
    public static $CIB_CARD_BIN = [
        486861,
        523036,
        451289,
        527414,
        528057,
        622901,
        622922,
        628212,
        451290,
        524070,
        625084,
        625085,
        625086,
        625087,
        548738,
        549633,
        552398,
        625082,
        625083,
        625960,
        461982,
        486493,
        486494,
        625961,
        622902,
        625353,
        625356,
        625962,
        625963
    ];

    //深圳发展银行
    public static $SDB_CARD_BIN = [
        435744,
        435745,
        483536,
        622525,
        622526,
        998801,
        998802
    ];

    //建设银行卡bin
    public static $CCB_CARD_BIN = [
        436728,
        453242,
        491031,
        53242,
        53243,
        544033,
        622707,
        625955,
        625956,
        553242,
        5453242,
        5491031,
        5544033,
        622725,
        622728,
        559051,
        622166,
        622168,
        622708,
        625964,
        625965,
        625966,
        628266,
        628366,
        628317,
        356896,
        356899,
        356895,
        436718,
        436738,
        436745,
        436748,
        489592,
        531693,
        532450,
        532458,
        544887,
        552801,
        557080,
        558895,
        625362,
        625363,
        628316
    ];

    //招商银行
    public static $CMB_CARD_BIN = [
        356886,
        523649,
        356888,
        356890,
        439188,
        439227,
        479228,
        479229,
        521302,
        356889,
        545620,
        545621,
        545947,
        545948,
        552534,
        552587,
        622575,
        622576,
        622577,
        622578,
        622579,
        545619,
        622581,
        622582,
        545623,
        356885,
        628290,
        356887,
        370285,
        370286,
        370287,
        370289,
        439225,
        518710,
        518718,
        628362,
        439226,
        628262,
        625802,
        625803,
    ];

    //中国银行
    public static $BOC_CARD_BIN = [
        625908,
        625910,
        625909,
        356833,
        356835,
        409665,
        409666,
        409668,
        409669,
        409670,
        409671,
        409672,
        512315,
        512316,
        512411,
        512412,
        514957,
        409667,
        518378,
        518379,
        518474,
        518475,
        518476,
        438088,
        524865,
        525745,
        525746,
        547766,
        552742,
        553131,
        558868,
        514958,
        622752,
        622753,
        622755,
        524864,
        622757,
        622758,
        622759,
        622760,
        622761,
        622762,
        622763,
        625337,
        625338,
        622756,
        628388,
        622754,
        622764,
        518377,
        622765,
        622788,
        558869,
        377677,
        625905,
        625906,
        625907,
        628313,
        625333,
        628312,
        625040,
        625042,
        625055
    ];

    //浦发银行卡bin
    public static $SPDB_CARD_BIN = [
        625957,
        625993,
        622519,
        625958,
        625831,
        356851,
        356852,
        404738,
        404739,
        456418,
        498451,
        515672,
        356850,
        517650,
        525998,
        622177,
        622277,
        622520,
        628222,
        622500,
        628221,
        622176,
        622276,
        622228,
        377187,
        625970,
        625971
    ];

    //平安银行卡bin
    public static $PAB_CARD_BIN = [
        627069,
        627066,
        627067,
        625361,
        531659,
        622157,
        528020,
        622155,
        622156,
        526855,
        356869,
        356868,
        625360,
        625823,
        625825,
        628296,
        627068
    ];

    //华夏银行卡bin
    public static $HXB_CARD_BIN = [
        628318,
        622636,
        625967,
        625968,
        625969,
        523959,
        528709,
        539867,
        539868,
        622637,
        622638,
        528708
    ];

    //中信银行
    public static $ECITIC_CARD_BIN = [
        376968,
        376969,
        400360,
        403391,
        403392,
        376966,
        404158,
        404159,
        404171,
        404172,
        404173,
        404174,
        404157,
        433667,
        433668,
        433669,
        514906,
        403393,
        520108,
        433666,
        558916,
        622678,
        622679,
        622680,
        622688,
        622689,
        628206,
        556617,
        628209,
        518212,
        628208,
        356390,
        356391,
        356392,
        622916,
        622918,
        622919,
        628370,
        628371,
        628372
    ];

    //交通银行卡bin
    public static $BOCOM_CARD_BIN = [
        434910,
        458124,
        520169,
        522964,
        552853,
        622250,
        622251,
        521899,
        622254,
        622255,
        622256,
        622257,
        622253,
        622284,
        622656,
        628216,
        622252,
        6649104,
        955590,
        955591,
        955592,
        955593,
        6653783,
        628218,
        49104,
        53783,
        458123
    ];

    //民生银行卡bin
    public static $CMBC_CARD_BIN = [
        545393,
        464580,
        464581,
        523952,
        545217,
        553161,
        356858,
        622623,
        625912,
        625913,
        625911,
        377155,
        377152,
        377153,
        377158,
        545431,
        545447,
        356859,
        356857,
        407405,
        421869,
        421870,
        421871,
        512466,
        356856,
        528948,
        552288,
        622600,
        622601,
        622602,
        517636,
        622621,
        628258,
        556610,
        545392,
        622603
    ];

    //广发银行卡bin
    public static $GDB_CARD_BIN = [
        436771,
        520152,
        520382,
        541709,
        541710,
        548844,
        552794,
        493427,
        622555,
        622556,
        622557,
        622558,
        622559,
        622560,
        528931,
        685800,
        6858000,
        558894,
        625072,
        625071,
        628260,
        628259,
        625805,
        625806,
        625807,
        625808,
        625809,
        625810,
        406365,
        406366,
        428911,
        436768,
        436769,
        436770,
        487013,
        491032,
        491033,
        491034,
        491035,
        491036,
        491037,
        491038,
        518364
    ];

}
